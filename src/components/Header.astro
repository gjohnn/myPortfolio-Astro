---
import "../styles/global.css";
import { t, localePath, getAlternateLang } from "../i18n/utils";
import { defaultLang, type Lang } from "../i18n/ui";

interface Props {
  lang?: Lang;
}

const { lang = defaultLang } = Astro.props;
const altLang = getAlternateLang(lang);

// Build alternate URL for language toggle
const currentPath = Astro.url.pathname;
// Strip the lang prefix to get the base path
let basePath = currentPath;
if (lang !== defaultLang) {
  basePath = currentPath.replace(`/${lang}`, '') || '/';
}
const altUrl = localePath(basePath, altLang);
---

<header
  class="fixed top-0 w-full py-3 z-50"
  style="background: var(--comic-white); border-bottom: 4px solid var(--comic-black); box-shadow: 0 4px 0 var(--comic-black);"
>
  <nav class="flex justify-between items-center px-6 max-w-7xl mx-auto">
    <!-- Comic Logo -->
    <div class="flex items-center">
      <a href={localePath('/', lang)} class="group relative flex items-center space-x-3">
        <div class="relative flex items-center justify-center w-12 h-12 rounded-lg transform rotate-[-3deg] group-hover:rotate-[3deg] transition-transform duration-300"
             style="background: var(--comic-red); border: 3px solid var(--comic-black); box-shadow: 3px 3px 0 var(--comic-black);">
          <span class="text-xl text-white" style="font-family: var(--font-comic); letter-spacing: 1px;">JG</span>
        </div>
        <div class="hidden sm:block">
          <span class="text-lg font-bold transition-colors" 
                style="font-family: var(--font-comic); color: var(--comic-black); letter-spacing: 1px;">
            Juan S. Guerrero Britos
          </span>
          <p class="text-xs font-bold" style="font-family: var(--font-accent); color: var(--comic-blue);">
            {t('header.role', lang)}
          </p>
        </div>
      </a>
    </div>

    <!-- Desktop Nav -->
    <div class="hidden lg:flex items-center gap-3">
      <ul class="flex justify-center items-center gap-2 list-none p-0 m-0">
        <li>
          <a class="nav-link relative px-4 py-2 font-bold rounded-lg transition-all duration-200"
             style="font-family: var(--font-comic); color: var(--comic-black); letter-spacing: 1px; font-size: 1.1rem;"
             href={localePath('/', lang)}>
            <i class="fas fa-home mr-1" style="color: var(--comic-red);"></i>
            {t('nav.home', lang)}
            <span class="nav-indicator"></span>
          </a>
        </li>
        <li>
          <a class="nav-link relative px-4 py-2 font-bold rounded-lg transition-all duration-200"
             style="font-family: var(--font-comic); color: var(--comic-black); letter-spacing: 1px; font-size: 1.1rem;"
             href={localePath('/experience', lang)}>
            <i class="fas fa-briefcase mr-1" style="color: var(--comic-blue);"></i>
            {t('nav.experience', lang)}
            <span class="nav-indicator"></span>
          </a>
        </li>
        <li>
          <a class="nav-link relative px-4 py-2 font-bold rounded-lg transition-all duration-200"
             style="font-family: var(--font-comic); color: var(--comic-black); letter-spacing: 1px; font-size: 1.1rem;"
             href={localePath('/projects', lang)}>
            <i class="fas fa-code mr-1" style="color: var(--comic-orange);"></i>
            {t('nav.projects', lang)}
            <span class="nav-indicator"></span>
          </a>
        </li>
        <li>
          <a href={localePath('/cv', lang)} class="btn btn-primary group">
            <i class="fas fa-file-alt mr-2 group-hover:animate-bounce"></i>
            {t('nav.viewCv', lang)}
          </a>
        </li>
        <li>
          <a class="nav-link relative px-4 py-2 font-bold rounded-lg transition-all duration-200"
             style="font-family: var(--font-comic); color: var(--comic-black); letter-spacing: 1px; font-size: 1.1rem;"
             href={localePath('/contact', lang)}>
            <i class="fas fa-envelope mr-1" style="color: var(--comic-green);"></i>
            {t('nav.contact', lang)}
            <span class="nav-indicator"></span>
          </a>
        </li>
      </ul>
      
      <!-- Language Toggle (Desktop) -->
      <a href={altUrl}
         class="lang-toggle flex items-center gap-1 px-3 py-1.5 rounded-lg font-bold transition-all duration-200 text-sm"
         style="font-family: var(--font-comic); background: var(--comic-cream); border: 2px solid var(--comic-black); box-shadow: 2px 2px 0 var(--comic-black); color: var(--comic-black); letter-spacing: 1px;"
         aria-label={`Switch to ${altLang === 'es' ? 'Spanish' : 'English'}`}>
        <i class="fas fa-globe" style="color: var(--comic-blue);"></i>
        {altLang.toUpperCase()}
      </a>
    </div>

    <!-- Mobile: Language Toggle + Hamburger -->
    <div class="flex lg:hidden items-center gap-3">
      <!-- Language Toggle (Mobile) -->
      <a href={altUrl}
         class="lang-toggle flex items-center gap-1 px-2.5 py-1.5 rounded-lg font-bold transition-all duration-200 text-sm"
         style="font-family: var(--font-comic); background: var(--comic-cream); border: 2px solid var(--comic-black); box-shadow: 2px 2px 0 var(--comic-black); color: var(--comic-black); letter-spacing: 1px;"
         aria-label={`Switch to ${altLang === 'es' ? 'Spanish' : 'English'}`}>
        <i class="fas fa-globe text-xs" style="color: var(--comic-blue);"></i>
        {altLang.toUpperCase()}
      </a>
      
      <button
        id="hamburger"
        class="relative p-3 focus:outline-none transition-all duration-300 rounded-lg group"
        style="color: var(--comic-black);"
        aria-label="Toggle mobile menu"
      >
        <div class="w-6 h-6 flex flex-col justify-center items-center">
          <span id="hamburgerLine1" class="block w-6 h-0.5 bg-current transition-all duration-300" style="background: var(--comic-black);"></span>
          <span id="hamburgerLine2" class="block w-6 h-0.5 bg-current transition-all duration-300 mt-1.5" style="background: var(--comic-black);"></span>
          <span id="hamburgerLine3" class="block w-6 h-0.5 bg-current transition-all duration-300 mt-1.5" style="background: var(--comic-black);"></span>
        </div>
      </button>
    </div>
  </nav>

  <!-- Mobile Dropdown -->
  <div
    id="dropdownMenu"
    class="lg:hidden hidden absolute w-full left-0 top-full"
    style="background: var(--comic-cream); border-bottom: 4px solid var(--comic-black); box-shadow: 0 4px 0 var(--comic-black);"
  >
    <div class="max-w-7xl mx-auto px-6 py-6">
      <ul class="flex flex-col gap-2">
        <li>
          <a class="mobile-nav-link flex items-center px-4 py-3 rounded-lg transition-all duration-200 font-bold"
             style="font-family: var(--font-comic); color: var(--comic-black); letter-spacing: 1px;"
             href={localePath('/', lang)}>
            <i class="fas fa-home mr-3 w-5" style="color: var(--comic-red);"></i>
            {t('nav.home', lang)}
          </a>
        </li>
        <li>
          <a class="mobile-nav-link flex items-center px-4 py-3 rounded-lg transition-all duration-200 font-bold"
             style="font-family: var(--font-comic); color: var(--comic-black); letter-spacing: 1px;"
             href={localePath('/experience', lang)}>
            <i class="fas fa-briefcase mr-3 w-5" style="color: var(--comic-blue);"></i>
            {t('nav.experience', lang)}
          </a>
        </li>
        <li>
          <a class="mobile-nav-link flex items-center px-4 py-3 rounded-lg transition-all duration-200 font-bold"
             style="font-family: var(--font-comic); color: var(--comic-black); letter-spacing: 1px;"
             href={localePath('/projects', lang)}>
            <i class="fas fa-code mr-3 w-5" style="color: var(--comic-orange);"></i>
            {t('nav.projects', lang)}
          </a>
        </li>
        <li class="mt-4 pt-4" style="border-top: 3px dashed var(--comic-black);">
          <a href={localePath('/cv', lang)} class="btn btn-primary w-full justify-center">
            <i class="fas fa-file-alt mr-2"></i>
            {t('nav.viewCv', lang)}
          </a>
        </li>
        <li class="mt-2">
          <a class="mobile-nav-link flex items-center px-4 py-3 rounded-lg transition-all duration-200 font-bold"
             style="font-family: var(--font-comic); color: var(--comic-black); letter-spacing: 1px;"
             href={localePath('/contact', lang)}>
            <i class="fas fa-envelope mr-3 w-5" style="color: var(--comic-green);"></i>
            {t('nav.contact', lang)}
          </a>
        </li>
      </ul>
    </div>
  </div>
</header>

<style>
  .nav-indicator {
    position: absolute;
    bottom: -2px;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 3px;
    background: var(--comic-red);
    transition: width 0.3s ease;
    border-radius: 2px;
  }

  .nav-link:hover .nav-indicator {
    width: 100%;
  }

  .nav-link:hover {
    transform: skewX(-3deg);
    background: var(--comic-yellow-light);
  }

  .mobile-nav-link:hover {
    background: var(--comic-yellow-light);
    transform: translateX(4px);
  }

  .lang-toggle:hover {
    background: var(--comic-yellow-light);
    transform: translateY(-1px);
    box-shadow: 3px 3px 0 var(--comic-black);
  }

  .lang-toggle:active {
    transform: translateY(1px);
    box-shadow: 1px 1px 0 var(--comic-black);
  }

  #hamburgerLine1.active {
    transform: rotate(45deg) translate(5px, 5px);
  }

  #hamburgerLine2.active {
    opacity: 0;
  }

  #hamburgerLine3.active {
    transform: rotate(-45deg) translate(7px, -6px);
  }
</style>

<script is:inline>
  document.addEventListener("DOMContentLoaded", () => {
    const hamburgerButton = document.getElementById("hamburger");
    const dropdownMenu = document.getElementById("dropdownMenu");
    const hamburgerLine1 = document.getElementById("hamburgerLine1");
    const hamburgerLine2 = document.getElementById("hamburgerLine2");
    const hamburgerLine3 = document.getElementById("hamburgerLine3");

    if (!hamburgerButton || !dropdownMenu || !hamburgerLine1 || !hamburgerLine2 || !hamburgerLine3) return;

    function toggleMenu() {
      const isMenuOpen = !dropdownMenu.classList.contains("hidden");
      if (isMenuOpen) {
        dropdownMenu.classList.add("hidden");
        hamburgerLine1.classList.remove("active");
        hamburgerLine2.classList.remove("active");
        hamburgerLine3.classList.remove("active");
      } else {
        dropdownMenu.classList.remove("hidden");
        hamburgerLine1.classList.add("active");
        hamburgerLine2.classList.add("active");
        hamburgerLine3.classList.add("active");
      }
    }

    function closeMenu() {
      if (dropdownMenu && !dropdownMenu.classList.contains("hidden")) {
        dropdownMenu.classList.add("hidden");
        hamburgerLine1.classList.remove("active");
        hamburgerLine2.classList.remove("active");
        hamburgerLine3.classList.remove("active");
      }
    }

    hamburgerButton.addEventListener("click", (e) => { e.stopPropagation(); toggleMenu(); });
    document.querySelectorAll(".mobile-nav-link").forEach((link) => { link.addEventListener("click", closeMenu); });
    document.addEventListener("click", (e) => {
      const target = e.target;
      if (target && dropdownMenu && hamburgerButton) {
        if (!dropdownMenu.contains(target) && !hamburgerButton.contains(target)) closeMenu();
      }
    });
    document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeMenu(); });

    // Active page highlighting
    const currentPath = window.location.pathname;
    const navLinks = document.querySelectorAll(".nav-link, .mobile-nav-link");
    navLinks.forEach(link => {
      const href = link.getAttribute("href");
      if (!href) return;
      // Normalize both paths for comparison
      const normCurrent = currentPath.replace(/\/$/, '') || '/';
      const normHref = href.replace(/\/$/, '') || '/';
      if (normHref === normCurrent) {
        link.style.background = 'var(--comic-yellow-light)';
      }
    });

    let resizeTimeout;
    window.addEventListener("resize", () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => { if (window.innerWidth >= 1024) closeMenu(); }, 100);
    });
  });
</script>
